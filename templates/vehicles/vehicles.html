{% extends "base.html" %}

{% block title %}Транспорт - {{ system_info.system.name }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Заголовок страницы -->
    <div class="page-header">
        <div class="page-title-section">
            <h1 class="card-title"><i class="fas fa-truck"></i> Список транспортных средств</h1>
            <p class="page-subtitle">Управление и отслеживание автопарка</p>
        </div>
        <div class="page-actions">
            <button class="btn btn-primary" onclick="addVehicle()">
                <i class="fas fa-plus"></i>
                Добавить автомобиль
            </button>
        </div>
    </div>

    <!-- Статистика -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-car"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ stats.total }}</div>
                <div class="stat-label">Всего</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-play-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ stats.active }}</div>
                <div class="stat-label">Активные</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-wrench"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ stats.maintenance }}</div>
                <div class="stat-label">На ТО</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-pause-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ stats.inactive }}</div>
                <div class="stat-label">Неактивные</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-file-archive"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ stats.retired }}</div>
                <div class="stat-label">Выбыли</div>
            </div>
        </div>
    </div>

    <!-- Фильтр -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title"><i class="fas fa-filter"></i> Фильтры</h3>
        </div>
        <div class="card-body">
            <form method="GET" class="filter-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Марка</label>
                        <select name="brand" class="form-control">
                            <option value="">Все марки</option>
                            {% for brand_item in brands %}
                            <option value="{{ brand_item }}" {% if brand == brand_item %}selected{% endif %}>{{ brand_item }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Статус</label>
                        <select name="status" class="form-control">
                            <option value="">Все статусы</option>
                            <option value="Active" {% if status == 'Active' %}selected{% endif %}>Активные</option>
                            <option value="Inactive" {% if status == 'Inactive' %}selected{% endif %}>Неактивные</option>
                            <option value="Maintenance" {% if status == 'Maintenance' %}selected{% endif %}>На ТО</option>
                            <option value="Retired" {% if status == 'Retired' %}selected{% endif %}>Выбыли</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Год от</label>
                        <input type="number" name="year_from" class="form-control" 
                               value="{{ year_from }}" placeholder="2000" min="1990" max="2030">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Год до</label>
                        <input type="number" name="year_to" class="form-control" 
                               value="{{ year_to }}" placeholder="2023" min="1990" max="2030">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Пробег от (км)</label>
                        <input type="number" name="mileage_min" class="form-control" 
                               value="{{ mileage_min }}" placeholder="0" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Пробег до (км)</label>
                        <input type="number" name="mileage_max" class="form-control" 
                               value="{{ mileage_max }}" placeholder="100000" min="0">
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter"></i>
                        Применить фильтры
                    </button>
                    <a href="{{ url_for('vehicles') }}" class="btn btn-outline">
                        <i class="fas fa-times"></i>
                        Сбросить фильтры
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Таблица транспорта -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title"><i class="fas fa-list"></i> Транспортные средства</h3>
        <div class="table-info">
            Показано {{ cars.items|length }} из {{ total }} записей
        </div>
    </div>
    <div class="card-body">
        {% if cars.items %}
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>
                            <a href="?{% for key, value in request.args.items() if key not in ['sort_by', 'sort_order', 'page'] %}{{ key }}={{ value }}&{% endfor %}sort_by=brand&sort_order={% if sort_by == 'brand' and sort_order == 'asc' %}desc{% else %}asc{% endif %}"
                            class="sort-link">
                                Марка
                                {% if sort_by == 'brand' %}
                                    {% if sort_order == 'asc' %}
                                        <i class="fas fa-sort-up"></i>
                                    {% else %}
                                        <i class="fas fa-sort-down"></i>
                                    {% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th>Модель</th>
                        <th>
                            <a href="?{% for key, value in request.args.items() if key not in ['sort_by', 'sort_order', 'page'] %}{{ key }}={{ value }}&{% endfor %}sort_by=year&sort_order={% if sort_by == 'year' and sort_order == 'asc' %}desc{% else %}asc{% endif %}"
                            class="sort-link">
                                Год
                                {% if sort_by == 'year' %}
                                    {% if sort_order == 'asc' %}
                                        <i class="fas fa-sort-up"></i>
                                    {% else %}
                                        <i class="fas fa-sort-down"></i>
                                    {% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th>ГОСНомер</th>
                        <th>
                            <a href="?{% for key, value in request.args.items() if key not in ['sort_by', 'sort_order', 'page'] %}{{ key }}={{ value }}&{% endfor %}sort_by=mileage&sort_order={% if sort_by == 'mileage' and sort_order == 'asc' %}desc{% else %}asc{% endif %}"
                            class="sort-link">
                                Пробег
                                {% if sort_by == 'mileage' %}
                                    {% if sort_order == 'asc' %}
                                        <i class="fas fa-sort-up"></i>
                                    {% else %}
                                        <i class="fas fa-sort-down"></i>
                                    {% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="?{% for key, value in request.args.items() if key not in ['sort_by', 'sort_order', 'page'] %}{{ key }}={{ value }}&{% endfor %}sort_by=status&sort_order={% if sort_by == 'status' and sort_order == 'asc' %}desc{% else %}asc{% endif %}"
                            class="sort-link">
                                Статус
                                {% if sort_by == 'status' %}
                                    {% if sort_order == 'asc' %}
                                        <i class="fas fa-sort-up"></i>
                                    {% else %}
                                        <i class="fas fa-sort-down"></i>
                                    {% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th>Цвет</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for car in cars.items %}
                    <tr>
                        <td data-label="Марка">{{ car.brand }}</td>
                        <td data-label="Модель">{{ car.model }}</td>
                        <td data-label="Год">{{ car.year }}</td>
                        <td data-label="ГОСНомер">{{ car.licensePlate }}</td>
                        <td data-label="Пробег">{{ "{:,}".format(car.mileage) if car.mileage else 0 }} км</td>
                        <td data-label="Статус">
                            <span class="badge 
                                {{ 'badge-success' if car.status == 'Active' else 
                                   'badge-warning' if car.status == 'Maintenance' else 
                                   'badge-secondary' if car.status == 'Inactive' else 
                                   'badge-danger' }}">
                                {{ 'Активный' if car.status == 'Active' else 
                                   'На ТО' if car.status == 'Maintenance' else 
                                   'Неактивный' if car.status == 'Inactive' else 
                                   'Выбыл' }}
                            </span>
                        </td>
                        <td data-label="Цвет">{{ car.color or '—' }}</td>
                        <td data-label="Действия">
                            <div class="table-actions">
                                <a href="{{ url_for('vehicle_detail', car_id=car.CarID) }}" 
                                   class="btn btn-sm btn-outline" title="Подробнее">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ url_for('edit_vehicle', car_id=car.CarID) }}" 
                                   class="btn btn-sm btn-outline" title="Редактировать">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{{ url_for('maintenance_records') }}?car_id={{ car.CarID }}" 
                                   class="btn btn-sm btn-outline" title="ТО">
                                    <i class="fas fa-wrench"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Пагинация -->
{% if total > per_page %}
<div class="pagination-container">
    <div class="pagination-info">
        Страница {{ page }} из {{ total_pages }} (всего {{ total }} записей)
    </div>
    <div class="pagination">
        {% set base_params = {} %}
        {% for key, value in request.args.items() %}
            {% if key not in ['page', 'sort_by', 'sort_order'] %}
                {% set _ = base_params.update({key: value}) %}
            {% endif %}
        {% endfor %}
        
        {% if cars.has_prev %}
            <a href="?{% for key, value in base_params.items() %}{{ key }}={{ value }}&{% endfor %}sort_by={{ sort_by }}&sort_order={{ sort_order }}&page={{ page - 1 }}" 
               class="page-link">&laquo;</a>
        {% endif %}
        
        {% for p in range([1, page - 2]|max, [total_pages, page + 2]|min + 1) %}
            {% if p >= page - 2 and p <= page + 2 %}
                <a href="?{% for key, value in base_params.items() %}{{ key }}={{ value }}&{% endfor %}sort_by={{ sort_by }}&sort_order={{ sort_order }}&page={{ p }}" 
                   class="page-link {{ 'active' if p == page else '' }}">{{ p }}</a>
            {% endif %}
        {% endfor %}
        
        {% if cars.has_next %}
            <a href="?{% for key, value in base_params.items() %}{{ key }}={{ value }}&{% endfor %}sort_by={{ sort_by }}&sort_order={{ sort_order }}&page={{ page + 1 }}" 
               class="page-link">&raquo;</a>
        {% endif %}
    </div>
</div>
{% endif %}
        
        {% else %}
        <div class="no-data">
            <i class="fas fa-truck-loading"></i>
            <h3>Транспортные средства не найдены</h3>
            <p>Попробуйте изменить параметры фильтрации или добавьте новый автомобиль</p>
            <button class="btn btn-primary" onclick="addVehicle()">
                <i class="fas fa-plus"></i>
                Добавить автомобиль
            </button>
        </div>
        {% endif %}
    </div>
</div>
</div>

<script>
function addVehicle() {
    window.location.href = '/vehicles/add';
}
</script>

{% endblock %}
